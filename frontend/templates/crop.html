<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×—×™×ª×•×š ×¡×“×¨×ª×™ ×©×œ ××•×ª×™×•×ª</title>
  <style>
    /* ×¨×§×¢ ×“×™× ××™ */
    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #9138e5, #3498db, #ff333d, #ffcb57);
      background-size: 300% 300%;
      animation: gradientMove 15s ease infinite;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      position: relative;
    }
    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    h1 {
      margin: 15px;
      font-size: 2rem;
      text-shadow: 0 0 8px rgba(0,0,0,0.5), 0 0 15px rgba(255,255,255,0.6);
    }

    /* ×‘×¨ ×”××•×ª×™×•×ª */
    #letters-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 90vw;
      margin: 10px 0;
      gap: 8px;
    }
    .letter {
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(6px);
      color: #fff;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .letter:hover {
      transform: scale(1.08);
      box-shadow: 0 0 10px rgba(255,255,255,0.7);
    }
    .letter.done {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      border: none;
      color: white;
      box-shadow: 0 0 12px rgba(46,204,113,0.9);
    }
    .letter.active {
      border: 2px solid #fff;
      background: rgba(52,152,219,0.6);
      box-shadow: 0 0 15px rgba(52,152,219,0.9);
    }

    /* ×§×•× ×˜×™×™× ×¨ ×ª××•× ×” */
    #image-container {
      position: relative;
      max-width: 90vw;
      max-height: 70vh;
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      touch-action: none;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.5);
    }
    #source-image {
      display: block;
      max-width: 100%;
      max-height: 70vh;
      object-fit: contain;
    }
    #crop-rectangle {
      position: absolute;
      border: 3px dashed #ff5555;
      background: rgba(255,85,85,0.15);
      top: 40px;
      left: 40px;
      width: 180px;
      height: 180px;
      box-sizing: border-box;
      cursor: move;
      border-radius: 12px;
      box-shadow: 0 0 18px rgba(255,85,85,0.7);
    }
    .resize-handle {
      position: absolute;
      width: 16px;
      height: 16px;
      background: #ff5555;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(255,85,85,0.9);
    }
    .resize-handle.nw { top:-8px; left:-8px; cursor:nwse-resize; }
    .resize-handle.ne { top:-8px; right:-8px; cursor:nesw-resize; }
    .resize-handle.sw { bottom:-8px; left:-8px; cursor:nesw-resize; }
    .resize-handle.se { bottom:-8px; right:-8px; cursor:nwse-resize; }

    /* ×›×¤×ª×•×¨×™× */
    #controls {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }
    button, a#downloadFontBtn {
      padding: 12px 22px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg, #3498db, #9b59b6);
      box-shadow: 0 6px 18px rgba(0,0,0,0.3);
      backdrop-filter: blur(6px);
      text-decoration: none;
      transition: all 0.3s ease;
    }
    button:hover, a#downloadFontBtn:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 10px 22px rgba(0,0,0,0.45);
      background: linear-gradient(135deg, #2980b9, #8e44ad);
    }

    /* ×¡×˜×˜×•×¡ */
    #status {
      margin-top: 12px;
      font-weight: bold;
      color: #ffeb3b;
      min-height: 1.2em;
      text-shadow: 0 0 8px rgba(0,0,0,0.6);
    }

    /* progress bar */
    #progress-container {
      margin-top: 12px;
      width: 220px;
      height: 22px;
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 12px;
      overflow: hidden;
      display: none;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(4px);
    }
    #progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00c6ff, #ff6b6b, #fddb92);
      background-size: 300% 300%;
      animation: gradientMove 5s linear infinite;
      transition: width 0.2s ease;
    }

    /* FinisherHeader */
    .finisher-header {
      position: fixed;
      top:0;
      left:0;
      width:100vw;
      height:100vh;
      z-index:-1;
      overflow:hidden;
    }
  </style>
</head>
<body>
  <!-- ××œ×× ×˜ FinisherHeader -->
  <div class="finisher-header"></div>

  <h1>×—×™×ª×•×š ×¡×“×¨×ª×™ ×©×œ ××•×ª×™×•×ª</h1>
  <div id="letters-bar"></div>
  <div id="image-container">
    {% if filename %}
      <img id="source-image" src="{{ url_for('static', filename='uploads/' + filename) }}" alt="×ª××•× ×” ×œ×—×™×ª×•×š" />
      <div id="crop-rectangle">
        <div class="resize-handle nw"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle se"></div>
      </div>
    {% else %}
      <p style="color:red; font-weight:bold;">×œ× × ×˜×¢× ×” ×ª××•× ×”. ×—×–×•×¨ ×œ××¡×š ×”×¨××©×™ ×•×‘×—×¨ ×§×•×‘×¥.</p>
    {% endif %}
  </div>

  <div id="controls" {% if not filename %}style="display:none;"{% endif %}>
    <button id="save-crop">×©××•×¨ ××•×ª × ×•×›×—×™×ª</button>
    <button id="undo-crop">×‘×˜×œ ×—×™×ª×•×š ××—×¨×•×Ÿ</button>
    <button id="generateFontBtn" style="display:none;" onclick="createFont()">×¦×•×¨ ×¤×•× ×˜</button>
    <a id="downloadFontBtn" href="#" download style="display:none;">â¬‡ ×”×•×¨×“ ××ª ×”×¤×•× ×˜</a>
  </div>
  <div id="status"></div>
  <div id="progress-container"><div id="progress-bar"></div></div>

  <script src="{{ url_for('static', filename='finisher-header.es5.min.js') }}"></script>
  <script>
    new FinisherHeader({
      "count": 6,
      "size": { "min": 1100, "max": 1300, "pulse": 0 },
      "speed": { "x": { "min":0.1,"max":0.3 }, "y": { "min":0.1,"max":0.3 } },
      "colors": { "background":"transparent", "particles":["#6bd6ff","#ffcb57","#ff333d"] },
      "blending": "overlay",
      "opacity": { "center":1,"edge":0.1 },
      "skew": -2,
      "shapes": ["c"]
    });
  </script>

  <script>
    {% if filename %}
    // ================== ×—×™×ª×•×š, Undo, Save, Letters, CreateFont ==================
    const container = document.getElementById('image-container');
    const img = document.getElementById('source-image');
    const cropRect = document.getElementById('crop-rectangle');
    const statusEl = document.getElementById('status');
    const lettersBar = document.getElementById('letters-bar');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const generateBtn = document.getElementById("generateFontBtn");
    const downloadBtn = document.getElementById("downloadFontBtn");
    const minWidth=30, minHeight=30;
    let drag=false, resize=false, resizeDir='', startX,startY, origX,origY, origWidth,origHeight, lastCropPosition=null;
    const letters=['×','×‘','×’','×“','×”','×•','×–','×—','×˜','×™','×›','×œ','×','× ','×¡','×¢','×¤','×¦','×§','×¨','×©','×ª','×š','×','×Ÿ','×£','×¥'];
    let currentIndex=0, history=[];

    // ×‘× ×™×™×ª ×”××•×ª×™×•×ª
    letters.forEach((ltr,i)=>{
      const el=document.createElement('div');
      el.className='letter';
      if(i===currentIndex) el.classList.add('active');
      el.textContent=ltr;
      lettersBar.appendChild(el);
    });
    function updateLettersBar(){
      [...lettersBar.children].forEach((child,i)=>{
        child.classList.remove('active');
        if(i===currentIndex) child.classList.add('active');
      });
    }
    function clamp(val,min,max){return Math.min(Math.max(val,min),max);}
    function getEventPos(e){return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY};}

    // ×’×¨×™×¨×”
    cropRect.addEventListener('mousedown', startDrag);
    cropRect.addEventListener('touchstart', startDrag, {passive:false});
    function startDrag(e){
      if(e.target.classList.contains('resize-handle')) return;
      e.preventDefault();
      drag=true;
      const pos=getEventPos(e);
      startX=pos.x; startY=pos.y;
      const rect=cropRect.getBoundingClientRect();
      origX=rect.left; origY=rect.top;
      window.addEventListener('mousemove',onDrag);
      window.addEventListener('touchmove',onDrag,{passive:false});
      window.addEventListener('mouseup',stopDrag);
      window.addEventListener('touchend',stopDrag);
    }
    function onDrag(e){
      if(!drag) return;
      e.preventDefault();
      const pos=getEventPos(e);
      const dx=pos.x-startX, dy=pos.y-startY;
      const containerRect=container.getBoundingClientRect();
      const imgRect=img.getBoundingClientRect();
      let newLeft=origX+dx, newTop=origY+dy;
      newLeft=clamp(newLeft, imgRect.left, imgRect.right-cropRect.offsetWidth);
      newTop=clamp(newTop, imgRect.top, imgRect.bottom-cropRect.offsetHeight);
      cropRect.style.left=(newLeft-containerRect.left)+'px';
      cropRect.style.top=(newTop-containerRect.top)+'px';
    }
    function stopDrag(){
      drag=false;
      window.removeEventListener('mousemove',onDrag);
      window.removeEventListener('touchmove',onDrag);
      window.removeEventListener('mouseup',stopDrag);
      window.removeEventListener('touchend',stopDrag);
    }

    // ×©×™× ×•×™ ×’×•×“×œ
    document.querySelectorAll('.resize-handle').forEach(h=>{
      h.addEventListener('mousedown', startResize);
      h.addEventListener('touchstart', startResize,{passive:false});
    });
    function startResize(e){
      e.preventDefault();
      resize=true;
      resizeDir=[...e.target.classList].find(c=>['nw','ne','sw','se'].includes(c));
      const pos=getEventPos(e);
      startX=pos.x; startY=pos.y;
      const rect=cropRect.getBoundingClientRect();
      origX=rect.left; origY=rect.top;
      origWidth=cropRect.offsetWidth; origHeight=cropRect.offsetHeight;
      window.addEventListener('mousemove',onResize);
      window.addEventListener('touchmove',onResize,{passive:false});
      window.addEventListener('mouseup',stopResize);
      window.addEventListener('touchend',stopResize);
    }
    function onResize(e){
      if(!resize) return;
      e.preventDefault();
      const pos=getEventPos(e);
      let dx=pos.x-startX, dy=pos.y-startY;
      let newLeft=parseInt(cropRect.style.left), newTop=parseInt(cropRect.style.top), newWidth=origWidth, newHeight=origHeight;
      if(resizeDir.includes('n')){ newTop += dy; newHeight -= dy; }
      if(resizeDir.includes('w')){ newLeft += dx; newWidth -= dx; }
      if(resizeDir.includes('e')){ newWidth += dx; }
      if(resizeDir.includes('s')){ newHeight += dy; }
      newWidth = Math.max(minWidth,newWidth);
      newHeight = Math.max(minHeight,newHeight);
      cropRect.style.left=newLeft+'px';
      cropRect.style.top=newTop+'px';
      cropRect.style.width=newWidth+'px';
      cropRect.style.height=newHeight+'px';
    }
    function stopResize(){
      resize=false;
      window.removeEventListener('mousemove',onResize);
      window.removeEventListener('touchmove',onResize);
      window.removeEventListener('mouseup',stopResize);
      window.removeEventListener('touchend',stopResize);
    }

    // ×©××™×¨×”
    document.getElementById('save-crop').addEventListener('click', async()=>{
      if(!img.naturalWidth) return alert('×”×ª××•× ×” ×¢×“×™×™×Ÿ ×‘×˜×¢×™× ×”');
      const cropRectStyle=cropRect.getBoundingClientRect();
      const imgRect=img.getBoundingClientRect();
      const scaleX = img.naturalWidth / imgRect.width;
      const scaleY = img.naturalHeight / imgRect.height;
      const cropX=(cropRectStyle.left-imgRect.left)*scaleX;
      const cropY=(cropRectStyle.top-imgRect.top)*scaleY;
      const cropW=cropRectStyle.width*scaleX;
      const cropH=cropRectStyle.height*scaleY;
      const cropPosStr=`${Math.round(cropX)},${Math.round(cropY)},${Math.round(cropW)},${Math.round(cropH)}`;
      if(lastCropPosition===cropPosStr) return alert('×œ× × ×™×ª×Ÿ ×œ×—×ª×•×š ×©×•×‘ ×‘××•×ª×• ××™×§×•×. ×™×© ×œ×”×–×™×– ××ª ×”×¨×™×‘×•×¢.');
      lastCropPosition=cropPosStr;

      const cropCanvas=document.createElement('canvas');
      cropCanvas.width=cropW; cropCanvas.height=cropH;
      const cropCtx=cropCanvas.getContext('2d');
      cropCtx.drawImage(img,cropX,cropY,cropW,cropH,0,0,cropW,cropH);

      // ×©×—×•×¨ ×œ×‘×Ÿ
      const imgData=cropCtx.getImageData(0,0,cropCanvas.width,cropCanvas.height);
      const data=imgData.data;
      for(let i=0;i<data.length;i+=4){
        const avg=(data[i]+data[i+1]+data[i+2])/3;
        data[i]=data[i+1]=data[i+2]=avg;
      }
      cropCtx.putImageData(imgData,0,0);

      const res=await fetch('/backend/save_crop',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:letters[currentIndex],index:currentIndex,data:cropCanvas.toDataURL('image/png')})});
      const json=await res.json();
      if(json.error) return alert('×©×’×™××” ×‘×©××™×¨×”: '+json.error);

      history.push(currentIndex);
      lettersBar.children[currentIndex].classList.add('done');
      currentIndex++;
      updateLettersBar();
      if(currentIndex>=letters.length){
        statusEl.textContent='ğŸ‰ ×›×œ ×”××•×ª×™×•×ª × ×©××¨×•! ×œ×—×¥ ×¢×œ "×¦×•×¨ ×¤×•× ×˜" ×›×“×™ ×œ×”×¤×™×§ ××ª ×”×¤×•× ×˜.';
        generateBtn.style.display='inline-block';
      } else statusEl.textContent=`âœ… ×”××•×ª "${letters[currentIndex-1]}" × ×©××¨×”! ×—×ª×•×š ××ª "${letters[currentIndex]}"`;
    });

    // Undo
    document.getElementById('undo-crop').addEventListener('click',()=>{
      if(history.length===0) return;
      currentIndex=history.pop();
      lettersBar.children[currentIndex].classList.remove('done');
      statusEl.textContent=`ğŸ”„ ×—×™×ª×•×š ×”××•×ª "${letters[currentIndex]}" ×‘×•×˜×œ.`;
      updateLettersBar();
    });

    // ×™×¦×™×¨×ª ×¤×•× ×˜
    async function createFont() {
      statusEl.textContent = "ğŸ“¦ ×™×•×¦×¨×™× ××ª ×”×¤×•× ×˜... ×‘×¢×•×“ ×¨×’×¢ ×ª×•×¢×‘×¨×• ×œ×“×£ ×”×‘×™×ª, ×ª×•×“×” ×¢×œ ×”×¡×‘×œ× ×•×ª ğŸ™";
      fetch("/generate-font", { method: "POST" }).catch(err => console.error("âš ï¸ ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¤×•× ×˜:", err));
      setTimeout(() => { window.location.href = "/"; }, 3000);
    }

    {% endif %}
  </script>
</body>
</html>
