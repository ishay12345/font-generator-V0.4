<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>חיתוך סדרתי של אותיות</title>
<style>
/* רקע דינמי צבעוני */
body {
  margin: 0; padding: 0;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  color: #fff;
  display: flex; flex-direction: column; align-items: center;
  min-height: 100vh; position: relative;
  background: linear-gradient(135deg, #9138e5, #3498db, #ff333d, #ffcb57);
  background-size: 300% 300%;
  animation: gradientMove 15s ease infinite;
}

@keyframes gradientMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

h1 { margin: 10px; font-size: 2rem; text-shadow: 0 0 8px rgba(0,0,0,0.5),0 0 15px rgba(255,255,255,0.6);}
#intro { font-size: 1.2rem; margin: 10px; text-align: center; text-shadow: 0 0 6px rgba(0,0,0,0.6);}
#instructions {
  font-size: 0.95rem; margin: 10px; max-width: 90vw; line-height: 1.5;
  background: rgba(0,0,0,0.3); padding: 12px 16px; border-radius: 12px; backdrop-filter: blur(6px);
}
#letters-bar { display: flex; flex-wrap: wrap; justify-content: center; max-width: 90vw; margin: 10px 0; gap: 8px; }
.letter {
  padding: 8px 12px; border-radius: 12px; cursor: pointer; user-select: none;
  background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(6px); color: #fff; font-weight: bold; transition: all 0.3s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.letter:hover { transform: scale(1.08); box-shadow: 0 0 10px rgba(255,255,255,0.7); }
.letter.done { background: linear-gradient(135deg, #27ae60, #2ecc71); border: none; color: white; box-shadow: 0 0 12px rgba(46,204,113,0.9); }
.letter.active { border: 2px solid #fff; background: rgba(52,152,219,0.6); box-shadow:0 0 15px rgba(52,152,219,0.9); }
#current-letter { font-size: 1.1rem; font-weight: bold; margin: 5px 0; padding: 6px 12px; border-radius: 12px; background: rgba(52, 152, 219, 0.6); color: #fff; text-align: center; min-width: 120px; }

#image-container {
  position: relative;
  width: 90vw; 
  max-height: 70vh;
  display: flex; 
  justify-content: center; 
  align-items: center;
  user-select: none; 
  touch-action: none;
}

#source-image {
  display: block;
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

#crop-rectangle {
  position: absolute;
  border: 3px dashed #ff5555;
  background: rgba(255,85,85,0.15);
  width: 180px;
  height: 180px;
  top: 0;
  left: 0;
  cursor: move;
  border-radius: 12px;
  box-shadow: 0 0 18px rgba(255,85,85,0.7);
}

.resize-handle { position: absolute; width: 16px; height: 16px; background: #ff5555; border-radius: 50%; box-shadow: 0 0 8px rgba(255,85,85,0.9); }
.resize-handle.nw { top:-8px; left:-8px; cursor:nwse-resize; }
.resize-handle.ne { top:-8px; right:-8px; cursor:nesw-resize; }
.resize-handle.sw { bottom:-8px; left:-8px; cursor:nesw-resize; }
.resize-handle.se { bottom:-8px; right:-8px; cursor:nwse-resize; }

#controls { margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
button {
  padding: 12px 22px; border: none; border-radius: 12px; font-size: 1rem; cursor: pointer;
  color: #fff; background: linear-gradient(135deg, #3498db, #9b59b6); box-shadow: 0 6px 18px rgba(0,0,0,0.3);
  backdrop-filter: blur(6px); text-decoration: none; transition: all 0.3s ease;
}
button:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 10px 22px rgba(0,0,0,0.45); background: linear-gradient(135deg, #2980b9, #8e44ad); }

#status { margin-top: 12px; font-weight: bold; color: #ffeb3b; min-height: 1.2em; text-shadow:0 0 8px rgba(0,0,0,0.6); }
#progress-container { margin-top: 12px; width: 220px; height: 22px; border: 2px solid rgba(255,255,255,0.5); border-radius: 12px; overflow: hidden; display: none; background: rgba(255,255,255,0.15); backdrop-filter: blur(4px);}
#progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg,#00c6ff,#ff6b6b,#fddb92); background-size:300% 300%; animation: gradientMove 5s linear infinite; transition: width 0.2s ease;}
#downloadBtn { padding:12px 22px; border-radius:12px; background:#27ae60; color:#fff; font-weight:bold; text-decoration:none; display:none; }
</style>
</head>
<body>
<h1> השלב האחרון : חיתוך האותיות </h1>
<div id="intro">⏱ עוד דקה ויש לכם פונט אישי!</div>

<div id="instructions">
  1️⃣ חתכו את האות בתוך הריבוע יחסית ברווח  אבל לא יותר מידי <br>
  2️⃣ עקבו אחרי ההוראות למטה ופס האותיות – איזו אות לחתוך ואם ביטלתם אותה – איזו צריך לחתוך שוב<br>
  3️⃣ שימו לב לא לחתוך את האותיות קרוב לגבולות התמונה אחרת הפונט לא יצא  טוב...<br>
  4️⃣ אחרי שסיימתם – לחצו על "צור פונט" והוא יעביר אתכם להורדה<br>
  5️⃣ דוגמא מלאה – <a href="https://www.youtube.com/watch?v=fakeURL" target="_blank" style="color:#ffeb3b;">צפו בסרטון יוטיוב</a>
</div>

<div id="letters-bar"></div>
<div id="current-letter">חתכו את האות א</div>

<div id="image-container">
  {% if filename %}
    <img id="source-image" src="{{ url_for('static', filename='uploads/' + filename) }}" alt="תמונה לחיתוך" />
    <div id="crop-rectangle">
      <div class="resize-handle nw"></div>
      <div class="resize-handle ne"></div>
      <div class="resize-handle sw"></div>
      <div class="resize-handle se"></div>
    </div>
  {% else %}
    <p style="color:red; font-weight:bold;">לא נטענה תמונה. חזור למסך הראשי ובחר קובץ.</p>
  {% endif %}
</div>

<div id="controls" {% if not filename %}style="display:none;"{% endif %}>
  <button id="save-crop">שמור אות נוכחית</button>
  <button id="undo-crop">בטל חיתוך אחרון</button>
  <button id="generateFontBtn" style="display:none;">צור פונט</button>
  <a id="downloadFontBtn" href="#" download style="display:none;">⬇ הורד את הפונט</a>
</div>
<div id="status"></div>
<div id="progress-container"><div id="progress-bar"></div></div>
<script>
{% if filename %}
const lettersBar = document.getElementById('letters-bar');
const letters = ['א','ב','ג','ד','ה','ו','ז','ח','ט','י','כ','ל','מ','נ','ס','ע','פ','צ','ק','ר','ש','ת','ך','ם','ן','ף','ץ'];
let currentIndex = 0, history = [];
const currentLetterEl = document.getElementById('current-letter');
const generateBtn = document.getElementById('generateFontBtn');
const downloadBtn = document.getElementById('downloadFontBtn');

letters.forEach((ltr,i)=>{
  const el = document.createElement('div');
  el.className='letter';
  if(i===0) el.classList.add('active');
  el.textContent = ltr;
  lettersBar.appendChild(el);
});

function updateLettersBar(){
  [...lettersBar.children].forEach((child,i)=>{
    child.classList.remove('active');
    if(i===currentIndex) child.classList.add('active');
  });
  if(currentIndex<letters.length) currentLetterEl.textContent=`חתכו את האות ${letters[currentIndex]}`;
}

// --- Drag & Resize ---
const cropRect=document.getElementById('crop-rectangle');
const img=document.getElementById('source-image');
const container=document.getElementById('image-container');
let drag=false, resize=false, resizeDir='', startX,startY, origX,origY, origW,origH, lastCropPosition=null;
const minWidth=30,minHeight=30;

function getEventPos(e){return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY};}
function clamp(val,min,max){return Math.min(Math.max(val,min),max);}

cropRect.addEventListener('mousedown', startDrag);
cropRect.addEventListener('touchstart', startDrag, {passive:false});

function startDrag(e){
  if(e.target.classList.contains('resize-handle')) return;
  e.preventDefault(); 
  drag=true; 
  const pos=getEventPos(e); 
  startX=pos.x; 
  startY=pos.y; 
  const rect=cropRect.getBoundingClientRect();
  origX=rect.left - container.getBoundingClientRect().left;
  origY=rect.top - container.getBoundingClientRect().top;
  window.addEventListener('mousemove',onDrag);
  window.addEventListener('touchmove',onDrag,{passive:false});
  window.addEventListener('mouseup',stopDrag);
  window.addEventListener('touchend',stopDrag);
}

function onDrag(e){
  if(!drag) return; 
  e.preventDefault(); 
  const pos=getEventPos(e);
  let dx=pos.x-startX, dy=pos.y-startY;
  let newLeft=clamp(origX+dx,0,container.offsetWidth-cropRect.offsetWidth);
  let newTop=clamp(origY+dy,0,container.offsetHeight-cropRect.offsetHeight);
  cropRect.style.left=newLeft+'px';
  cropRect.style.top=newTop+'px';
}

function stopDrag(){
  drag=false; 
  window.removeEventListener('mousemove',onDrag);
  window.removeEventListener('touchmove',onDrag);
  window.removeEventListener('mouseup',stopDrag);
  window.removeEventListener('touchend',stopDrag);
}

// --- Resize Handles ---
document.querySelectorAll('.resize-handle').forEach(h=>{
  h.addEventListener('mousedown', startResize); 
  h.addEventListener('touchstart', startResize,{passive:false}); 
});

function startResize(e){
  e.preventDefault(); 
  resize=true; 
  resizeDir=[...e.target.classList].find(c=>['nw','ne','sw','se'].includes(c)); 
  const pos=getEventPos(e); 
  startX=pos.x; 
  startY=pos.y; 
  origX=parseInt(cropRect.style.left)||0;
  origY=parseInt(cropRect.style.top)||0;
  origW=cropRect.offsetWidth; 
  origH=cropRect.offsetHeight; 
  window.addEventListener('mousemove',onResize);
  window.addEventListener('touchmove',onResize,{passive:false});
  window.addEventListener('mouseup',stopResize);
  window.addEventListener('touchend',stopResize);
}

function onResize(e){
  if(!resize) return; 
  e.preventDefault(); 
  const pos=getEventPos(e); 
  let dx=pos.x-startX, dy=pos.y-startY; 
  let newLeft=origX, newTop=origY, newWidth=origW, newHeight=origH;
  if(resizeDir.includes('n')){ newTop += dy; newHeight -= dy; }
  if(resizeDir.includes('w')){ newLeft += dx; newWidth -= dx; }
  if(resizeDir.includes('e')){ newWidth += dx; }
  if(resizeDir.includes('s')){ newHeight += dy; }
  newWidth=Math.max(minWidth,newWidth); 
  newHeight=Math.max(minHeight,newHeight);
  cropRect.style.left=newLeft+'px'; 
  cropRect.style.top=newTop+'px'; 
  cropRect.style.width=newWidth+'px'; 
  cropRect.style.height=newHeight+'px';
}

function stopResize(){
  resize=false; 
  window.removeEventListener('mousemove',onResize);
  window.removeEventListener('touchmove',onResize);
  window.removeEventListener('mouseup',stopResize);
  window.removeEventListener('touchend',stopResize);
}

// --- Save Crop ---
document.getElementById('save-crop').addEventListener('click', async()=>{
  if(!img.naturalWidth) return alert('התמונה עדיין בטעינה');
  const rect=cropRect.getBoundingClientRect(), imgRect=img.getBoundingClientRect();
  const scaleX=img.naturalWidth/imgRect.width, scaleY=img.naturalHeight/imgRect.height;
  const cropX=(rect.left-imgRect.left)*scaleX;
  const cropY=(rect.top-imgRect.top)*scaleY;
  const cropW=rect.width*scaleX, cropH=rect.height*scaleY;
  const cropPosStr=`${Math.round(cropX)},${Math.round(cropY)},${Math.round(cropW)},${Math.round(cropH)}`;
  if(lastCropPosition===cropPosStr) return alert('לא ניתן לחתוך שוב באותו מיקום. יש להזיז את הריבוע.');
  lastCropPosition=cropPosStr;

  const canvas=document.createElement('canvas'); canvas.width=cropW; canvas.height=cropH;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,cropX,cropY,cropW,cropH,0,0,cropW,cropH);

  const res=await fetch('/backend/save_crop',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:letters[currentIndex],index:currentIndex,data:canvas.toDataURL('image/png')})});
  const json=await res.json();
  if(json.error) return alert('שגיאה בשמירה: '+json.error);

  history.push(currentIndex);
  lettersBar.children[currentIndex].classList.add('done');
  currentIndex++;
  updateLettersBar();
  if(currentIndex>=letters.length){
    document.getElementById('status').textContent='🎉 כל האותיות נשמרו! לחץ על "צור פונט" כדי להפיק את הפונט.';
    generateBtn.style.display='inline-block';
  } else document.getElementById('status').textContent=`✅ האות "${letters[currentIndex-1]}" נשמרה!`;
});

// Undo
document.getElementById('undo-crop').addEventListener('click',()=>{
  if(history.length===0) return;
  currentIndex=history.pop();
  lettersBar.children[currentIndex].classList.remove('done');
  document.getElementById('status').textContent=`🔄 חיתוך האות "${letters[currentIndex]}" בוטל.`;
  updateLettersBar();
});

// --- Generate Font with auto redirect ---
async function createFont() {
  const statusEl = document.getElementById('status');
  statusEl.textContent = "⏳ יוצרים את הפונט, המתן...";
  try {
    const res = await fetch("/generate_font", { method: "POST" });
    const data = await res.json();
    if (data.status === "success") {
      window.location.href = data.download_url;
    } else {
      statusEl.textContent = "❌ שגיאה ביצירת הפונט: " + data.message;
    }
  } catch(err){
    statusEl.textContent = "❌ שגיאה ביצירת הפונט: " + err.message;
  }
}
generateBtn.addEventListener('click',createFont);

updateLettersBar();
{% endif %}
</script>
</body>
</html>
